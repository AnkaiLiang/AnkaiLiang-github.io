<!DOCTYPE html>
<html lang="en">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Ankai Liang" />



<meta name="description" content="A tool of ec2--how to write a shell tool">
<meta name="keywords" content="System Administration">
<meta property="og:type" content="article">
<meta property="og:title" content="Afewmore">
<meta property="og:url" content="https://AnkaiLiang.github.io/2017/08/17/afewmore-A-tool-of-ec2-how-to-write-a-shell-tool/index.html">
<meta property="og:site_name" content="Ankai Liang&#39;s Blog">
<meta property="og:description" content="A tool of ec2--how to write a shell tool">
<meta property="og:updated_time" content="2017-08-17T07:28:35.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Afewmore">
<meta name="twitter:description" content="A tool of ec2--how to write a shell tool">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="Ankai Liang&#39;s Blog" type="application/atom+xml">



    <link rel="shortcut icon" href="/img/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>Afewmore | Ankai Liang&#39;s Blog</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Ankai Liang</a></h1>
        </hgroup>

        
        <p class="header-subtitle">强而不燥，弱而不虚</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>Menu</li>
                        <li>Tags</li>
                        
                        <li>Friends</li>
                        
                        
                        <li>About Me</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">Home</a></li>
                        
                            <li><a href="/archives/">All Article</a></li>
                        
                            <li><a href="/tags/">tags</a></li>
                        
                            <li><a href="/about/">Resume</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="/lakeandgod@gmail.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" href="http://weibo.com/1783077873/profile?rightmod=1&wvr=6&mod=personnumber" title="新浪微博"></a>
                            
                                <a class="fa GitHub" href="https://github.com/ankaiLiang" title="GitHub"></a>
                            
                                <a class="fa Facebook" href="https://www.facebook.com/lakeandgod" title="Facebook"></a>
                            
                                <a class="fa LinkedIn" href="https://www.linkedin.com/in/ankai-liang-a774b3119?trk=hp-identity-name" title="LinkedIn"></a>
                            
                                <a class="fa Instagram" href="https://www.instagram.com/ankai_liang/" title="Instagram"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Distrubute-System/">Distrubute System</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/System-Administration/">System Administration</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="http://jayveehe.github.io">Jayvee He的博客</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://wangzi6147.github.io">wangzi的博客</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">true</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Ankai Liang</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Ankai Liang</a></h1>
            </hgroup>
            
            <p class="header-subtitle">强而不燥，弱而不虚</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">Home</a></li>
                
                    <li><a href="/archives/">All Article</a></li>
                
                    <li><a href="/tags/">tags</a></li>
                
                    <li><a href="/about/">Resume</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="/lakeandgod@gmail.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" target="_blank" href="http://weibo.com/1783077873/profile?rightmod=1&wvr=6&mod=personnumber" title="新浪微博"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/ankaiLiang" title="GitHub"></a>
                            
                                <a class="fa Facebook" target="_blank" href="https://www.facebook.com/lakeandgod" title="Facebook"></a>
                            
                                <a class="fa LinkedIn" target="_blank" href="https://www.linkedin.com/in/ankai-liang-a774b3119?trk=hp-identity-name" title="LinkedIn"></a>
                            
                                <a class="fa Instagram" target="_blank" href="https://www.instagram.com/ankai_liang/" title="Instagram"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="Tags" friends="Friends" about="About Me"/>
</nav>
      <div class="body-wrap"><article id="post-afewmore-A-tool-of-ec2-how-to-write-a-shell-tool" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/17/afewmore-A-tool-of-ec2-how-to-write-a-shell-tool/" class="article-date">
      <time datetime="2017-08-17T04:32:41.000Z" itemprop="datePublished">2017-08-17</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Afewmore
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/System-Administration/">System Administration</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><ul>
<li>link: <a href="http://www.cs.stevens.edu/~jschauma/615/s17-hw6.html" target="_blank" rel="external">http://www.cs.stevens.edu/~jschauma/615/s17-hw6.html</a></li>
</ul>
<h2 id="Objective"><a href="#Objective" class="headerlink" title="Objective:"></a>Objective:</h2><p>The objective of this assignment is for you to write a simple system tool to perform a realistic sysadmin task using the EC2 environment. In doing so, you will practice the core principles of writing scalable system tools as discussed in class.</p>
<p>You will also learn to implement a program from a high-level specification. In so doing, you will practice the detection of hidden requirements and decision making in the face of ambiguity.</p>
<p>This assignment is worth 50 points.</p>
<p>Summary:</p>
<p>Implement the afewmore command as specified in this manual page.</p>
<p>Your program will behave exactly as outlined in that manual page, with no additional output or functionality.</p>
<p>Target platform:</p>
<p>The tool you write will be executed (and graded) on an Ubuntu instance ami-6de0dd04 with the ‘awscli’ package installed via ‘sudo apt-get install awscli’. If your tool does not work in this environment, you will not get any points. See also: general homework guidelines.</p>
<p>Programming language</p>
<p>You are free to choose any programming language you like to implement this tool. Obviously, the program needs to be executed/run on the Ubuntu instance, and must not require the additional installation of any tools, libraries etc. besides what is already installed there.</p>
<p>Program behaviour</p>
<p>Your program will not require any modification of the environment (ie, you can assume the user has his/her environment set up for EC2), and exection of the program will be exactly as outlined in the manual page afewmore(1).</p>
<p>Your program will be robust. That is, it will handle error conditions and erroneous input in a graceful manner. Make sure to consider all the edge cases!</p>
<hr>
<h1 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h1><h1 id="afewmore"><a href="#afewmore" class="headerlink" title="afewmore"></a>afewmore</h1><p>This is a task of CS615 in Stevens Institute of Technology.</p>
<p>Author</p>
<ul>
<li><a href="https://github.com/efitzpa1" target="_blank" rel="external">Eric Fitzpatrick</a></li>
<li><a href="https://github.com/AnkaiLiang" target="_blank" rel="external">Ankai Liang</a></li>
</ul>
<h1 id="Program-description"><a href="#Program-description" class="headerlink" title="Program description"></a>Program description</h1><p>For this homework assignment, our group used Bash as our programming language of choice. Bash allowed for us to easily interface with common shell commands and the AWS CLI tool. Since Bash has such low overhead, it also allows us to have competitive performance and write functionality compactly and directly.</p>
<h1 id="Challenges-faced"><a href="#Challenges-faced" class="headerlink" title="Challenges faced"></a>Challenges faced</h1><p>The main challenge that our group faced is how to determine when a newly created EC2 instance is ready to ssh into. We got around this challenge by using sleep(1) commands to first wait for the instance state to change to ‘Running’ and then attempting to ssh into the instance a few times after small time intervals.</p>
<h2 id="Manual"><a href="#Manual" class="headerlink" title="Manual"></a>Manual</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line">AFEWMORE(1)		  BSD General Commands Manual		   AFEWMORE(1)</div><div class="line"></div><div class="line">NAME</div><div class="line">     afewmore -- duplicate EC2 instances with their data directory</div><div class="line"></div><div class="line">SYNOPSIS</div><div class="line">     afewmore [-hv] [-d dir] [-n num] instance</div><div class="line"></div><div class="line">DESCRIPTION</div><div class="line">     The afewmore tool can be used to duplicate a given EC2 instance.  When</div><div class="line">     doing so, it creates multiple new instances and populates their data</div><div class="line">     directory by copying the data from the original.</div><div class="line"></div><div class="line">OPTIONS</div><div class="line">     The source instance is specified via the mandatory argument to afewmore.</div><div class="line">     In addition, the following command-line options are supported:</div><div class="line"></div><div class="line">     -d dir   Copy the contents of this data directory from the orignal source</div><div class="line">	      instance to all the new instances.  If not specified, defaults</div><div class="line">	      to /data.</div><div class="line"></div><div class="line">     -h       Print a usage statement and exit.</div><div class="line"></div><div class="line">     -n num   Create this many new instances.  If not specified, defaults to</div><div class="line">	      10.</div><div class="line"></div><div class="line">     -v       Be verbose.</div><div class="line"></div><div class="line">DETAILS</div><div class="line">     Frequently, it is necessary to duplicate a given server&apos;s configuration</div><div class="line">     or setup.	While configuration management and service orchestration sys-</div><div class="line">     tems may be able to perform this task, the afewmore tool allows for a</div><div class="line">     trivial initial bootstrapping that only concerns itself with data dupli-</div><div class="line">     cation, not host configuration.</div><div class="line"></div><div class="line">     Upon invocation, afewmore will identify the type of EC2 instance in ques-</div><div class="line">     tion and launch the requested number of duplicates.  It will then copy</div><div class="line">     the contents of the given directory from the source instance to all of</div><div class="line">     the newly created instances.</div><div class="line"></div><div class="line">OUTPUT</div><div class="line">     By default, afewmore prints the instance IDs of the newly created EC2</div><div class="line">     instances as the only output.  Unless an error occurs, no other output is</div><div class="line">     generated.</div><div class="line"></div><div class="line">     If the -v flag is given, afewmore may print meaningful diagnostic mes-</div><div class="line">     sages as it progresses to stdout.</div><div class="line"></div><div class="line">     Any errors encountered cause a meaningful error message to be printed to</div><div class="line">     STDERR.</div><div class="line"></div><div class="line">ENVIRONMENT</div><div class="line">     The afewmore tool is suitable to be used by any user and does not have</div><div class="line">     any user-specific settings or credentials hard coded.</div><div class="line"></div><div class="line">     afewmore assumes that the user has set up their environment for general</div><div class="line">     use with the EC2 tools.  That is, it will not set or modify any environ-</div><div class="line">     ment variables.</div><div class="line"></div><div class="line">     afewmore also assumes that the user has set up their ~/.ssh/config file</div><div class="line">     to access instances in EC2 via ssh(1) without any additional settings.</div><div class="line"></div><div class="line">EXIT STATUS</div><div class="line">     The afewmore will exit with a return status of 0 under normal circum-</div><div class="line">     stances.  If an error occurred, afewmore will exit with a value &gt;0.</div><div class="line"></div><div class="line">EXAMPLES</div><div class="line">     The following examples illustrate common usage of this tool.</div><div class="line"></div><div class="line">     To create ten more instances of the EC2 instance i-0a1b2c3d4f and copy</div><div class="line">     the contents of the &apos;/data&apos; directory from that instance:</div><div class="line"></div><div class="line">	   $ afewmore i-0a1b2c3d4f</div><div class="line">	   i-1a1b2c3d4f</div><div class="line">	   i-2a1b2c3d4f</div><div class="line">	   i-3a1b2c3d4f</div><div class="line">	   i-4a1b2c3d4f</div><div class="line">	   i-5a1b2c3d4f</div><div class="line">	   i-6a1b2c3d4f</div><div class="line">	   i-7a1b2c3d4f</div><div class="line">	   i-8a1b2c3d4f</div><div class="line">	   i-9a1b2c3d4f</div><div class="line">	   i-0b1b2c3d4f</div><div class="line">	   $ echo $?</div><div class="line">	   0</div><div class="line">	   $</div><div class="line"></div><div class="line">     To create just one more instance and copy the contents of the directory</div><div class="line">     &apos;/usr/local/share&apos;:</div><div class="line"></div><div class="line">	   $ afewmore -d /usr/local/share -n 1 i-0a1b2c3d4f</div><div class="line">	   i-1a1b2c3d4f</div><div class="line">	   $</div><div class="line"></div><div class="line">SEE ALSO</div><div class="line">     aws help, ssh(1), tar(1), rsync(1)</div><div class="line"></div><div class="line">HISTORY</div><div class="line">     afewmore was originally assigned by Jan Schaumann</div><div class="line">     &lt;jschauma@cs.stevens.edu&gt; as a homework assignment for the class &quot;Aspects</div><div class="line">     of System Administration&quot; at Stevens Institute of Technology in the</div><div class="line">     Spring of 2017.</div><div class="line"></div><div class="line">BSD				April 09, 2017				   BSD</div></pre></td></tr></table></figure>
<h2 id="The-commentary"><a href="#The-commentary" class="headerlink" title="The commentary"></a>The commentary</h2><h3 id="Ankai-Liang"><a href="#Ankai-Liang" class="headerlink" title="Ankai Liang"></a>Ankai Liang</h3><p>I decide to use shell script to finish this task.</p>
<ol>
<li><p>At the beginning, I look for the arguments which inputted by user.<br>I found two way, one is manually dealing with them. It requires users to input arguments with explicit position. The other way is using <code>getopts</code>, a useful tool which can handle the short options.<br><a href="http://wiki.bash-hackers.org/howto/getopts_tutorial" target="_blank" rel="external">Tutorial</a><br>After testing, I found that if -d is missing an argument, it will instead of taking the next option as the parameter. So I added a check in each options which need value.</p>
</li>
<li><p>Then I need to grab the information of target instance by a given instance-id.<br>I learned how to write a funtion in Shell Script. When I test the result shell function return, I found <code>$?</code> only return the numeric result, and the variable without <code>local</code> declaration would domain global, a good choice to record the function result.<br>About the parameter passing, if I use variable to transfer the json data, it will lose the line feeds. So I use the temp file to store the json data.<br>By the way, using ‘&amp;’ to make <code>echo command</code> running in background in funtion and using ‘a=<code>func args</code>‘ outside is also a good way to implement funtion return. But in this way, it can’t exit entire script in function when meet error. Maybe the main shell create a sub-shell environment to run sub-command.<br>Tricky point, sometimes the response from aws contains some null data in some attributes. We should filter them by ‘grep “^$”‘</p>
</li>
<li><p>Next I try to ensure what is UserName when ssh to remote server. Create a table, acquire image-Description, and use awk to match UserName. When use awk to do regular expression searching, I have to transfer the shell variables into awk.<a href="https://www.gnu.org/software/gawk/manual/gawk.html#Using-Shell-Variables" target="_blank" rel="external">Tutorial</a></p>
</li>
<li><p>I want to check whether shell sucessfully ssh to the Target server. But I noticed when I offer the wrong username, cli will go into interface and ask for password. If I want to automaticlly deal with the interface, I need install <code>expect</code>, that’s unallowed. I don’t have a better way to solve it.</p>
</li>
<li><p>When trasfer the data between two instance, my test remote instance is NetBSD without rsync, I decided transfer the data by <code>scp</code>.</p>
</li>
<li><p>Because setting up instance need some time. so I have to wait a few seconds then execute the copy mission.</p>
</li>
<li><p>“Host key verification failed.” I fail to use <code>scp</code> transfer data from remote instance to another remote one. I realized scp can’t do that between two remote nodes. I need to copy one node’s rsa public key to the other, then use ssh into one remote to do that transmission.<br>After communication with classmates, I knew that <code>scp</code> has a option ‘-3’, which can transfer data between two remote instance via the local instance. According the principle of least astonishment, I think using <code>scp -3</code> without the change of <code>authorized_keys</code> file is the better solution.</p>
</li>
<li>Deal with the directory path. Before using <code>scp</code>, I have to make sure the directory’s parent path exists. Use pattern matching to adjust <code>${path}</code> and <code>mkdir -p</code> to create in new instance.</li>
<li>Implement all basic function!</li>
<li>When testing create instance with other images, I found some of OS login user accounts don’t have the authority to create new directory or files in some specific place. So I shoud chang the target directory authority to allow ssh write and execute.</li>
</ol>
<h3 id="Eric-Fitzpatrick"><a href="#Eric-Fitzpatrick" class="headerlink" title="Eric Fitzpatrick"></a>Eric Fitzpatrick</h3><p>Ankai and I chose to both develop our own independent versions of the ‘afewmore’ program and then collaborate to merge the best parts of our implementations together. I also used Bash so this process was straightforward. We took very similar approaches so I chose to refine the version on Ankai’s GitHub repository to match up to mine and use as our submission. My main contributions to his version was increasing the error handling capabilities of the program, increasing the verbosity of the usage statement (included flag information), and modifying the script to use the mktemp(1) function instead of an in-directory temp.txt file which could have potentially deleted or modified a user’s temp.txt file unintentionally. I also added a trap(1) statement to delete this temporary file upon a SIGINT signal (control+c).</p>
<hr>
<h1 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">catalog=<span class="string">"/data"</span></div><div class="line">num=10</div><div class="line">verbose=<span class="string">"false"</span></div><div class="line"></div><div class="line"><span class="function"><span class="title">cleanup</span></span>()</div><div class="line">&#123;</div><div class="line">    <span class="built_in">log</span> <span class="string">"Cleaning up temporary file"</span></div><div class="line">    rm <span class="_">-f</span> <span class="variable">$tmp</span></div><div class="line">    <span class="built_in">exit</span> 1</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="title">log</span></span>()</div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> [ <span class="string">"<span class="variable">$verbose</span>"</span> = <span class="string">"true"</span> ];</div><div class="line">	<span class="keyword">then</span></div><div class="line">		<span class="built_in">echo</span> <span class="variable">$@</span> </div><div class="line">	<span class="keyword">fi</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">iferr</span></span>()</div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> [ $? != 0 ];</div><div class="line">	<span class="keyword">then</span> </div><div class="line">		<span class="built_in">echo</span> <span class="variable">$@</span> &gt;&amp;2</div><div class="line">		<span class="built_in">exit</span> 1;</div><div class="line">	<span class="keyword">fi</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="title">usage</span></span>() </div><div class="line">&#123;</div><div class="line">	<span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"Usage: afewmore [-hv] [-d dir] [-n num] instance\n\n  -d dir  Copy the contents of this data directory from the original source\n          instance to all new instances. If not specified, defaults\n          to /data.\n\n  -h      Print a usage statement and exit.\n\n  -n num  Create this many new instances. If not specified, defaults to\n          10.\n\n  -v      Be verbose."</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="title">getInfo</span></span>()</div><div class="line">&#123;</div><div class="line">	((cat <span class="variable">$tmp</span> | grep <span class="string">"\"<span class="variable">$1</span>\""</span>) || (<span class="built_in">echo</span> <span class="string">"Fail to get the <span class="variable">$1</span> info."</span> &gt;&amp;2; <span class="built_in">exit</span> 1;))\</div><div class="line">	 | tr <span class="string">":\","</span> <span class="string">" "</span>  | awk <span class="string">'&#123;print $2&#125;'</span> | sort | uniq | grep -v <span class="string">"null"</span> | grep -v <span class="string">"^$"</span></div><div class="line"><span class="comment">#	delete the null line</span></div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="title">getAllInfo</span></span>()</div><div class="line">&#123;</div><div class="line">	InstanceId=<span class="variable">$1</span></div><div class="line">	aws ec2 describe-instances --output json --filters <span class="string">"Name=instance-id,Values=<span class="variable">$&#123;InstanceId&#125;</span>"</span> &gt; <span class="variable">$tmp</span></div><div class="line">	PublicDnsName=$(getInfo PublicDnsName)</div><div class="line">	ImageId=$(getInfo ImageId)</div><div class="line">	InstanceType=$(getInfo InstanceType)</div><div class="line">	KeyName=$(getInfo KeyName)</div><div class="line">	GroupName=$(getInfo GroupName)</div><div class="line">	AvailabilityZone=$(getInfo AvailabilityZone)</div><div class="line">	PublicDnsName=$(getInfo PublicDnsName)</div><div class="line">	iferr <span class="string">"Fail to get the info for <span class="variable">$&#123;InstanceId&#125;</span>. Please check instance-id and its state."</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">":d:n:hv"</span> arg; </div><div class="line"><span class="keyword">do</span></div><div class="line">	<span class="keyword">case</span> <span class="variable">$&#123;arg&#125;</span> <span class="keyword">in</span></div><div class="line">		h)</div><div class="line">			usage</div><div class="line">			<span class="built_in">exit</span> 0</div><div class="line">			;;</div><div class="line">		d)</div><div class="line">			catalog=<span class="variable">$&#123;OPTARG&#125;</span></div><div class="line">			<span class="keyword">if</span> ! [[ <span class="variable">$catalog</span> =~ ^/.*$ ]];</div><div class="line">			<span class="keyword">then</span></div><div class="line">				<span class="built_in">echo</span> <span class="string">"-d's argument is not a valid Unix style path"</span> &gt;&amp;2</div><div class="line">				usage</div><div class="line">				<span class="built_in">exit</span> 1;</div><div class="line">			<span class="keyword">fi</span></div><div class="line">			;;</div><div class="line">		n)	</div><div class="line">			<span class="keyword">if</span> [[ <span class="variable">$OPTARG</span> =~ ^[0-9]+$ ]]</div><div class="line">			<span class="keyword">then</span></div><div class="line">			    <span class="keyword">if</span> [ <span class="variable">$OPTARG</span> <span class="_">-gt</span> 0 ]</div><div class="line">			    <span class="keyword">then</span></div><div class="line">				num=<span class="variable">$&#123;OPTARG&#125;</span></div><div class="line">			    <span class="keyword">else</span></div><div class="line">				<span class="built_in">echo</span> <span class="string">"-n's argument must be greater than 0."</span> &gt;&amp;2</div><div class="line">				<span class="built_in">exit</span> 1;</div><div class="line">			    <span class="keyword">fi</span></div><div class="line">			<span class="keyword">else</span></div><div class="line">				<span class="built_in">echo</span> <span class="string">"-n's argument is not a number."</span> &gt;&amp;2</div><div class="line">				usage</div><div class="line">				<span class="built_in">exit</span> 1;</div><div class="line">			<span class="keyword">fi</span></div><div class="line">			;;</div><div class="line">		v)</div><div class="line">			verbose=<span class="string">"true"</span></div><div class="line">			;;</div><div class="line">		\?)</div><div class="line">			<span class="built_in">echo</span> <span class="string">"Unknown argument: -<span class="variable">$OPTARG</span>"</span> &gt;&amp;2</div><div class="line">			usage</div><div class="line">			<span class="built_in">exit</span> 1</div><div class="line">			;;</div><div class="line">		:)</div><div class="line">      		<span class="built_in">echo</span> <span class="string">"Option -<span class="variable">$OPTARG</span> requires an argument."</span> &gt;&amp;2</div><div class="line">      		usage</div><div class="line">     		<span class="built_in">exit</span> 1</div><div class="line">     		;;</div><div class="line">	<span class="keyword">esac</span></div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line"><span class="built_in">shift</span> $((OPTIND-1)) <span class="comment"># shift the instance id arguments to $1</span></div><div class="line"><span class="keyword">if</span> [ -z <span class="variable">$1</span> ];</div><div class="line"><span class="keyword">then</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">"Requires an instance id to point out which instance will be replicated."</span> &gt;&amp;2</div><div class="line">	usage</div><div class="line">	<span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="built_in">log</span> <span class="string">"Arguments format is correct."</span> </div><div class="line"><span class="built_in">log</span> <span class="string">"Tring to acquire target instance's info..."</span></div><div class="line"></div><div class="line"><span class="comment"># get the info for origin instance</span></div><div class="line"></div><div class="line">targetId=<span class="variable">$1</span></div><div class="line"><span class="keyword">if</span> ! [[ <span class="variable">$targetId</span> =~ ^i-[a-z0-9]+$ ]]</div><div class="line"><span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"Invalid instance ID '<span class="variable">$targetId</span>' provided."</span> &gt;&amp;2</div><div class="line">    usage</div><div class="line">    <span class="built_in">exit</span> 1;</div><div class="line"><span class="keyword">fi</span></div><div class="line">tmp=$(mktemp)</div><div class="line"><span class="built_in">trap</span> cleanup SIGINT</div><div class="line">getAllInfo <span class="variable">$targetId</span></div><div class="line">targetPublicDns=<span class="variable">$&#123;PublicDnsName&#125;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="built_in">log</span> <span class="string">"done"</span></div><div class="line"><span class="built_in">log</span> <span class="string">"Target instance info: InstanceId=<span class="variable">$&#123;InstanceId&#125;</span>, PublicDnsName=<span class="variable">$&#123;PublicDnsName&#125;</span>, InstanceType=<span class="variable">$&#123;InstanceType&#125;</span>,\</span></div><div class="line"> ImageId=<span class="variable">$&#123;ImageId&#125;</span>, KeyName=<span class="variable">$&#123;KeyName&#125;</span>, GroupName=<span class="variable">$&#123;GroupName&#125;</span>, AvailabilityZone=<span class="variable">$&#123;AvailabilityZone&#125;</span>"</div><div class="line"><span class="built_in">log</span> <span class="string">"Tring to ssh to target instance..."</span> </div><div class="line"></div><div class="line"><span class="comment">## get the username according to image-id</span></div><div class="line"></div><div class="line">aws ec2 describe-images --output json --filters <span class="string">"Name=image-id, Values=<span class="variable">$&#123;ImageId&#125;</span>"</span> &gt; <span class="variable">$tmp</span></div><div class="line">ImageName=$(getInfo Name)</div><div class="line">username=$(cat UsernameTable | awk -F <span class="string">":"</span> -v pat=<span class="string">"<span class="variable">$&#123;ImageName&#125;</span>"</span> <span class="string">'pat ~ $1 &#123; print $2 &#125;'</span> | head -1)</div><div class="line"><span class="keyword">if</span> [ -z <span class="variable">$&#123;username&#125;</span> ]</div><div class="line"><span class="keyword">then</span></div><div class="line">	username=<span class="string">"root"</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment">## check can we log into target instance and the directory is exist</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> ssh -o StrictHostKeyChecking=no -o LogLevel=quiet <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;targetPublicDns&#125;</span> :;</div><div class="line"><span class="keyword">then</span> </div><div class="line">	<span class="built_in">log</span> <span class="string">"successful ssh to the target instance"</span></div><div class="line">	<span class="built_in">log</span> <span class="string">"username=<span class="variable">$&#123;username&#125;</span>, ImageName=<span class="variable">$&#123;ImageName&#125;</span>"</span></div><div class="line"><span class="keyword">else</span> </div><div class="line">	<span class="built_in">echo</span> <span class="string">"Fail to ssh to the target instance"</span> &gt;&amp;2</div><div class="line">	<span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> ssh -o StrictHostKeyChecking=no <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;targetPublicDns&#125;</span> <span class="built_in">test</span> <span class="_">-e</span> <span class="variable">$&#123;catalog&#125;</span>;</div><div class="line"><span class="keyword">then</span></div><div class="line">	<span class="built_in">log</span> <span class="string">"<span class="variable">$&#123;catalog&#125;</span> exists on instance '<span class="variable">$targetId</span>'"</span></div><div class="line"><span class="keyword">else</span> </div><div class="line">	<span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;catalog&#125;</span> does not exist on instance '<span class="variable">$targetId</span>', please check the directory path"</span> &gt;&amp;2</div><div class="line">	<span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># create $&#123;num&#125; new instance. </span></div><div class="line"></div><div class="line"><span class="built_in">log</span> <span class="string">"Trying to create <span class="variable">$&#123;num&#125;</span> new instances..."</span></div><div class="line"></div><div class="line">aws ec2 run-instances --image-id <span class="variable">$&#123;ImageId&#125;</span> --count <span class="variable">$&#123;num&#125;</span> --instance-type\</div><div class="line"> <span class="variable">$&#123;InstanceType&#125;</span> --key-name <span class="variable">$&#123;KeyName&#125;</span> --security-groups <span class="variable">$&#123;GroupName&#125;</span> --placement AvailabilityZone=<span class="variable">$&#123;AvailabilityZone&#125;</span> &gt; <span class="variable">$tmp</span></div><div class="line">iferr <span class="string">"Fail to create new instances, plase check awscli configuration and network"</span></div><div class="line"></div><div class="line"><span class="built_in">log</span> <span class="string">"done"</span></div><div class="line"><span class="built_in">log</span> <span class="string">"Waiting for instances pending..."</span></div><div class="line">getInfo InstanceId &gt; listInstanceId.txt</div><div class="line">sleep 100s</div><div class="line"></div><div class="line"><span class="comment">## Deal with each new Instance</span></div><div class="line"><span class="keyword">for</span> line <span class="keyword">in</span> $(cat listInstanceId.txt)</div><div class="line"><span class="keyword">do</span></div><div class="line">	aws ec2 describe-instances --output json --filters <span class="string">"Name=instance-id,Values=<span class="variable">$&#123;line&#125;</span>"</span> &gt; <span class="variable">$tmp</span></div><div class="line">	state=$(getInfo Name)</div><div class="line">	i=0;</div><div class="line">	<span class="keyword">while</span> [ <span class="string">"<span class="variable">$&#123;state&#125;</span>"</span> != <span class="string">"running"</span> ];</div><div class="line">	<span class="keyword">do</span></div><div class="line">		i=$(( <span class="variable">$i</span> + 1 ))</div><div class="line">		sleep 5s</div><div class="line">		aws ec2 describe-instances --output json --filters <span class="string">"Name=instance-id,Values=<span class="variable">$&#123;line&#125;</span>"</span> &gt; <span class="variable">$tmp</span></div><div class="line">		state=$(getInfo Name) <span class="comment"># loop until state = running</span></div><div class="line">		<span class="keyword">if</span> [ <span class="variable">$&#123;i&#125;</span> <span class="_">-gt</span> 10 ]</div><div class="line">		<span class="keyword">then</span></div><div class="line">			<span class="built_in">echo</span> <span class="string">"Overtime, fail to get PublicDnsName for instance <span class="variable">$&#123;line&#125;</span>"</span> &gt;&amp;2</div><div class="line">		<span class="keyword">fi</span></div><div class="line">	<span class="keyword">done</span></div><div class="line">	</div><div class="line">	newPublicDnsName=$(getInfo PublicDnsName)</div><div class="line">	iferr <span class="string">"Fail to get newPublicDnsName for instance <span class="variable">$&#123;line&#125;</span>"</span></div><div class="line">	<span class="built_in">log</span> <span class="string">"newPublicDnsName=<span class="variable">$&#123;newPublicDnsName&#125;</span>"</span></div><div class="line"></div><div class="line">	<span class="built_in">log</span> <span class="string">"Testing ssh to new instance <span class="variable">$&#123;line&#125;</span>..."</span></div><div class="line">	i=0;</div><div class="line">	ssh -o StrictHostKeyChecking=no -o LogLevel=quiet <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;newPublicDnsName&#125;</span> :</div><div class="line">	<span class="keyword">while</span> [ $? != 0 ];</div><div class="line">	<span class="keyword">do</span></div><div class="line">		i=$(( <span class="variable">$i</span> + 1 ))</div><div class="line">		<span class="keyword">if</span> [ <span class="variable">$&#123;i&#125;</span> <span class="_">-gt</span> 15 ]</div><div class="line">		<span class="keyword">then</span></div><div class="line">			<span class="built_in">echo</span> <span class="string">"Fail ssh to new instance <span class="variable">$&#123;line&#125;</span>"</span> &gt;&amp;2</div><div class="line">		<span class="keyword">fi</span></div><div class="line">		sleep 5s</div><div class="line">		ssh -o StrictHostKeyChecking=no -o LogLevel=quiet <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;newPublicDnsName&#125;</span> :</div><div class="line">	<span class="keyword">done</span></div><div class="line">	<span class="built_in">log</span> <span class="string">"done"</span> </div><div class="line"></div><div class="line">	<span class="built_in">log</span> <span class="string">"Prepare the directory on new instance <span class="variable">$&#123;line&#125;</span>"</span></div><div class="line">	newcatalog=<span class="string">"<span class="variable">$&#123;catalog%/?*&#125;</span>"</span></div><div class="line">	ssh -o StrictHostKeyChecking=no -o LogLevel=quiet <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;newPublicDnsName&#125;</span> <span class="string">"(test -e <span class="variable">$&#123;newcatalog:="/"&#125;</span> || sudo mkdir -p <span class="variable">$&#123;newcatalog&#125;</span>) &amp;&amp; ([ -w <span class="variable">$&#123;newcatalog&#125;</span> ] &amp;&amp; [ -x <span class="variable">$&#123;newcatalog&#125;</span> ] || sudo chmod a+wx <span class="variable">$&#123;newcatalog&#125;</span>)"</span></div><div class="line">	iferr <span class="string">"Fail to create directory path on instance <span class="variable">$&#123;line&#125;</span>"</span></div><div class="line">	<span class="built_in">log</span> <span class="string">"Ready. newcatalog=<span class="variable">$newcatalog</span>"</span></div><div class="line"></div><div class="line"></div><div class="line">	<span class="built_in">log</span> <span class="string">"Running scp -3 from <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;targetPublicDns&#125;</span>:<span class="variable">$&#123;catalog&#125;</span> to <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;newPublicDnsName&#125;</span>:<span class="variable">$&#123;newcatalog&#125;</span>..."</span></div><div class="line">	scp -r -q -p -o StrictHostKeyChecking=no -o LogLevel=quiet -3 <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;targetPublicDns&#125;</span>:<span class="variable">$&#123;catalog&#125;</span> <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;newPublicDnsName&#125;</span>:<span class="variable">$&#123;newcatalog&#125;</span></div><div class="line">	iferr <span class="string">"Fail to copy directory content form <span class="variable">$&#123;targetId&#125;</span> to <span class="variable">$&#123;line&#125;</span>"</span></div><div class="line">	<span class="built_in">log</span> <span class="string">"done."</span></div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line"></div><div class="line">cat listInstanceId.txt</div><div class="line"><span class="built_in">log</span> <span class="string">"Success."</span></div><div class="line"></div><div class="line">rm <span class="variable">$tmp</span></div><div class="line">rm listInstanceId.txt</div><div class="line"><span class="built_in">exit</span> 0</div></pre></td></tr></table></figure>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>Title:</span><a href="/2017/08/17/afewmore-A-tool-of-ec2-how-to-write-a-shell-tool/">Afewmore</a></p>
        <p><span>Author:</span><a href="/" title="Back to Homepage">Ankai Liang</a></p>
        <p><span>Created:</span>2017-08-17, 00:32:41</p>
        <p><span>Updated:</span>2017-08-17, 03:28:35</p>
        <p>
            <span>Full URL:</span><a class="post-url" href="/2017/08/17/afewmore-A-tool-of-ec2-how-to-write-a-shell-tool/" title="Afewmore">https://AnkaiLiang.github.io/2017/08/17/afewmore-A-tool-of-ec2-how-to-write-a-shell-tool/</a>
            <span class="copy-path" data-clipboard-text="From https://AnkaiLiang.github.io/2017/08/17/afewmore-A-tool-of-ec2-how-to-write-a-shell-tool/　　By Ankai Liang" title="Copy Article&#39;s Link &amp; Author"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>License:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"CC BY-NC-SA 4.0"</a> Keep Link &amp; Author if Distribute.
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2017/08/17/Text-processing-in-Linux/">
                    Text-Processing
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2017/08/16/tcpdump-1-DNS/">
                    Tcpdump(1) DNS
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Description"><span class="toc-number">1.</span> <span class="toc-text">Description</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Objective"><span class="toc-number">1.1.</span> <span class="toc-text">Objective:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Content"><span class="toc-number">2.</span> <span class="toc-text">Content</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#afewmore"><span class="toc-number">3.</span> <span class="toc-text">afewmore</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Program-description"><span class="toc-number">4.</span> <span class="toc-text">Program description</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Challenges-faced"><span class="toc-number">5.</span> <span class="toc-text">Challenges faced</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Manual"><span class="toc-number">5.1.</span> <span class="toc-text">Manual</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-commentary"><span class="toc-number">5.2.</span> <span class="toc-text">The commentary</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ankai-Liang"><span class="toc-number">5.2.1.</span> <span class="toc-text">Ankai Liang</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eric-Fitzpatrick"><span class="toc-number">5.2.2.</span> <span class="toc-text">Eric Fitzpatrick</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Code"><span class="toc-number">6.</span> <span class="toc-text">Code</span></a></li></ol>
</div>
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="Hide"  title="Show or Hide Table of Contents">

<script>
    yiliaConfig.toc = ["Hide", "Show", !!"false"];
</script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"Afewmore　| Ankai Liang's Blog　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    
      <div class="duoshuo" id="comments">
    <div id="comment-box" ></div>
    <div class="ds-thread" id="ds-thread" data-thread-key="2017/08/17/afewmore-A-tool-of-ec2-how-to-write-a-shell-tool/" data-title="Afewmore" data-url="https://AnkaiLiang.github.io/2017/08/17/afewmore-A-tool-of-ec2-how-to-write-a-shell-tool/"></div>
    <script>
        var duoshuoQuery = {short_name:"ankailiang"};
        var loadComment = function(){
            var d = document, s = d.createElement('script');
            s.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            s.async = true; s.charset = 'UTF-8';
            (d.head || d.body).appendChild(s);
        }

        
    </script>
    
    <script> loadComment(); </script>

</div>
    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2017/08/17/Text-processing-in-Linux/" title="Pre: Text-Processing">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="Mini Archives"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2017/08/16/tcpdump-1-DNS/" title="Next: Tcpdump(1) DNS">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/08/17/DHT-REMOTE/">DHT-REMOTE</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/17/Page-Rank-Hadoop/">Page Rank - Hadoop</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/17/RushHour/">RushHour</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/17/Text-processing-in-Linux/">Text-Processing</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/17/afewmore-A-tool-of-ec2-how-to-write-a-shell-tool/">Afewmore</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/16/tcpdump-1-DNS/">Tcpdump(1) DNS</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/16/Using-Manages-packages-in-Linux/">Using Manages Packages in Linux</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/16/Using-the-AWS-CLI-to-set-instance/">Using the AWS-CLI to Set Instance</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/19/Install and Configure AWS Tools/">Install and Configure AWS Tools</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2017 Ankai Liang
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="A fast, simple &amp; powerful blog framework">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="Another simple and elegant theme for Hexo  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >Site Visitors: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">Page Hits: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="Back to Top"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="Comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="Go to Bottom"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>